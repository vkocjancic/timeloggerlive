/*
Created: 8. 05. 2017
Modified: 9. 05. 2017
Model: TimeLogger
Database: MS SQL Server 2016
*/
CREATE DATABASE TimeLogger
go

use [TimeLogger]
go


-- Create tables section -------------------------------------------------

-- Table CD_BILLING_OPTION

CREATE TABLE [CD_BILLING_OPTION]
(
 [BILLING_OPTION_ID] Bigint IDENTITY(1,1) NOT NULL,
 [CODE] Char(4) NOT NULL,
 [DESCRIPTION] Nvarchar(200) NOT NULL,
 [PAYMENTS_MY] Char(1) NOT NULL,
 [PRICE] Decimal(8,2) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [VALID_FROM] Date NOT NULL,
 [VALID_TO] Date NULL,
 [ACCOUNT_TYPE_ID] Smallint NOT NULL
)
go

-- Create indexes for table CD_BILLING_OPTION

CREATE INDEX [IX_Relationship8] ON [CD_BILLING_OPTION] ([ACCOUNT_TYPE_ID])
go

-- Add keys for table CD_BILLING_OPTION

ALTER TABLE [CD_BILLING_OPTION] ADD CONSTRAINT [Key1] PRIMARY KEY ([BILLING_OPTION_ID])
go

-- Table CD_ACCOUNT_TYPE

CREATE TABLE [CD_ACCOUNT_TYPE]
(
 [ACCOUNT_TYPE_ID] Smallint IDENTITY(1,1) NOT NULL,
 [CODE] Char(4) NOT NULL,
 [DESCRIPTION] Nvarchar(200) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [VALID_FROM] Date NOT NULL,
 [VALID_TO] Date NULL
)
go

-- Add keys for table CD_ACCOUNT_TYPE

ALTER TABLE [CD_ACCOUNT_TYPE] ADD CONSTRAINT [Key2] PRIMARY KEY ([ACCOUNT_TYPE_ID])
go

-- Table ACCOUNT

CREATE TABLE [ACCOUNT]
(
 [ACCOUNT_ID] Uniqueidentifier NOT NULL,
 [DESCRIPTION] Nvarchar(250) NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [OWNER_USER_ID] Uniqueidentifier NOT NULL
)
go

-- Create indexes for table ACCOUNT

CREATE INDEX [IX_Relationship11] ON [ACCOUNT] ([OWNER_USER_ID])
go

-- Add keys for table ACCOUNT

ALTER TABLE [ACCOUNT] ADD CONSTRAINT [Key3] PRIMARY KEY ([ACCOUNT_ID])
go

-- Table BILLING

CREATE TABLE [BILLING]
(
 [BILLING_ID] Uniqueidentifier NOT NULL,
 [PAY_PROVIDER_ID] Nvarchar(100) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [DATE_PAID] Datetime NULL,
 [BILLING_OPTION_ID] Bigint NOT NULL,
 [ACCOUNT_ID] Uniqueidentifier NOT NULL
)
go

-- Create indexes for table BILLING

CREATE INDEX [IX_Relationship9] ON [BILLING] ([BILLING_OPTION_ID])
go

CREATE INDEX [IX_Relationship10] ON [BILLING] ([ACCOUNT_ID])
go

-- Add keys for table BILLING

ALTER TABLE [BILLING] ADD CONSTRAINT [Key4] PRIMARY KEY ([BILLING_ID])
go

-- Table USER

CREATE TABLE [USER]
(
 [USER_ID] Uniqueidentifier NOT NULL,
 [EMAIL] Nvarchar(250) NOT NULL,
 [PASSWORD] Nvarchar(150) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL
)
go

-- Add keys for table USER

ALTER TABLE [USER] ADD CONSTRAINT [Key5] PRIMARY KEY ([USER_ID])
go

-- Table ACCOUNT_USER

CREATE TABLE [ACCOUNT_USER]
(
 [ACCOUNT_USER_ID] Uniqueidentifier NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [USER_ID] Uniqueidentifier NOT NULL,
 [ACCOUNT_ID] Uniqueidentifier NOT NULL
)
go

-- Create indexes for table ACCOUNT_USER

CREATE INDEX [IX_Relationship12] ON [ACCOUNT_USER] ([USER_ID])
go

CREATE INDEX [IX_Relationship13] ON [ACCOUNT_USER] ([ACCOUNT_ID])
go

-- Add keys for table ACCOUNT_USER

ALTER TABLE [ACCOUNT_USER] ADD CONSTRAINT [Key6] PRIMARY KEY ([ACCOUNT_USER_ID])
go

-- Table AUDIT

CREATE TABLE [AUDIT]
(
 [AUDIT_ID] Uniqueidentifier NOT NULL,
 [AUDIT_TYPE_IO] Char(1) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [USER_ID] Uniqueidentifier NULL
)
go

-- Create indexes for table AUDIT

CREATE INDEX [IX_Relationship14] ON [AUDIT] ([USER_ID])
go

-- Add keys for table AUDIT

ALTER TABLE [AUDIT] ADD CONSTRAINT [Key7] PRIMARY KEY ([AUDIT_ID])
go

-- Table TIME_LOG

CREATE TABLE [TIME_LOG]
(
 [TIME_LOG_ID] Uniqueidentifier NOT NULL,
 [FROM] Datetime NOT NULL,
 [TO] Datetime NOT NULL,
 [DESCRIPTION] Nvarchar(max) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [ASSIGNMENT_ID] Uniqueidentifier NULL,
 [USER_ID] Uniqueidentifier NULL
)
go

-- Create indexes for table TIME_LOG

CREATE INDEX [IX_Relationship16] ON [TIME_LOG] ([ASSIGNMENT_ID])
go

CREATE INDEX [IX_Relationship17] ON [TIME_LOG] ([USER_ID])
go

-- Add keys for table TIME_LOG

ALTER TABLE [TIME_LOG] ADD CONSTRAINT [Key8] PRIMARY KEY ([TIME_LOG_ID])
go

-- Table PROJECT

CREATE TABLE [PROJECT]
(
 [PROJECT_ID] Uniqueidentifier NOT NULL,
 [CODE] Nvarchar(200) NOT NULL,
 [DESCRIPTION] Nvarchar(max) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [USER_ID] Uniqueidentifier NULL
)
go

-- Create indexes for table PROJECT

CREATE INDEX [IX_Relationship19] ON [PROJECT] ([USER_ID])
go

-- Add keys for table PROJECT

ALTER TABLE [PROJECT] ADD CONSTRAINT [Key9] PRIMARY KEY ([PROJECT_ID])
go

-- Table ASSIGNMENT

CREATE TABLE [ASSIGNMENT]
(
 [ASSIGNMENT_ID] Uniqueidentifier NOT NULL,
 [CODE] Nvarchar(1) DEFAULT 200 NOT NULL,
 [DESCRIPTION] Nvarchar(max) NOT NULL,
 [CREATED] Datetime DEFAULT getdate() NOT NULL,
 [PROJECT_ID] Uniqueidentifier NULL,
 [USER_ID] Uniqueidentifier NULL
)
go

-- Create indexes for table ASSIGNMENT

CREATE INDEX [IX_Relationship15] ON [ASSIGNMENT] ([PROJECT_ID])
go

CREATE INDEX [IX_Relationship18] ON [ASSIGNMENT] ([USER_ID])
go

-- Add keys for table ASSIGNMENT

ALTER TABLE [ASSIGNMENT] ADD CONSTRAINT [Key10] PRIMARY KEY ([ASSIGNMENT_ID])
go

-- Create relationships section ------------------------------------------------- 

ALTER TABLE [CD_BILLING_OPTION] ADD CONSTRAINT [FK_BILLING_OPTION_ACCOUNT_TYPE] FOREIGN KEY ([ACCOUNT_TYPE_ID]) REFERENCES [CD_ACCOUNT_TYPE] ([ACCOUNT_TYPE_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [BILLING] ADD CONSTRAINT [FK_BILLING_BILLING_OPTION] FOREIGN KEY ([BILLING_OPTION_ID]) REFERENCES [CD_BILLING_OPTION] ([BILLING_OPTION_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [BILLING] ADD CONSTRAINT [FK_BILLING_ACCOUNT] FOREIGN KEY ([ACCOUNT_ID]) REFERENCES [ACCOUNT] ([ACCOUNT_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [ACCOUNT] ADD CONSTRAINT [FK_ACCOUNT_USER] FOREIGN KEY ([OWNER_USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [ACCOUNT_USER] ADD CONSTRAINT [FK_ACCOUNT_USER_USER] FOREIGN KEY ([USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [ACCOUNT_USER] ADD CONSTRAINT [FK_ACCOUNT_USER_ACCOUNT] FOREIGN KEY ([ACCOUNT_ID]) REFERENCES [ACCOUNT] ([ACCOUNT_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [AUDIT] ADD CONSTRAINT [FK_AUDIT_USER] FOREIGN KEY ([USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [ASSIGNMENT] ADD CONSTRAINT [FK_ASSIGNMENT_PROJECT] FOREIGN KEY ([PROJECT_ID]) REFERENCES [PROJECT] ([PROJECT_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [TIME_LOG] ADD CONSTRAINT [FK_TIME_LOG_ASSIGNMENT] FOREIGN KEY ([ASSIGNMENT_ID]) REFERENCES [ASSIGNMENT] ([ASSIGNMENT_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [TIME_LOG] ADD CONSTRAINT [FK_TIME_LOG_USER] FOREIGN KEY ([USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [ASSIGNMENT] ADD CONSTRAINT [FK_ASSIGNENT_USER] FOREIGN KEY ([USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go

ALTER TABLE [PROJECT] ADD CONSTRAINT [FK_PROJECT_USER] FOREIGN KEY ([USER_ID]) REFERENCES [USER] ([USER_ID]) ON UPDATE NO ACTION ON DELETE NO ACTION
go


-- Grant permissions section -------------------------------------------------




