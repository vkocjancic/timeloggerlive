"use strict";(function(n){function o(n){this.replacements=n}function i(n){this.element=n}function u(n){this.element=n;this.timeout=5e3}function r(t){this.element=n("#"+t);this.startDate=new Date}function t(t){this.regexTimeFormat=/(\d{1,2})[:.](\d{2})\s{0,1}(am|AM|pm|PM)?/;this.element=n("."+t);this.placeholderNewItem=n(".entry-ph",this.element);this.placeholderLog='<tr data-id="{data-id}"><td class="time"><div contenteditable="true">{from}<\/div><\/td><td class="time"><div contenteditable="true">{to}<\/div><\/td><td><div contenteditable="true">{description}<\/div><\/td><td>{action}<\/td><td>{status}<\/td><\/tr>';this.placeholderTotal=n(".entry-total",this.element);this.dateNavigationBar=f}var f=new r("date-nav"),e=new t("entry-list");n.prototype.textOnly=function(){return n(this).clone().children().remove().end().text()};Array.prototype.removeValue=function(t,i){var r=n.map(this,function(n){return n[t]===i?null:n});this.length=0;this.push.apply(this,r)};Date.prototype.locale={en:{month_names:["January","February","March","April","May","June","July","August","September","October","November","December"]}};Date.prototype.addDays=function(n){var t=new Date(this.valueOf());return t.setDate(t.getDate()+n),t};Date.prototype.getMonthName=function(n){return n=n&&n in this.locale?n:"en",this.locale[n].month_names[this.getMonth()]};o.prototype.format=function(n){var t=this.replacements,i=new RegExp(Object.keys(t).join("|"),"gi");return n.replace(i,function(n){return t[n]})};i.prototype.displayNew=function(){this.resetClass(this.element.get(0),"fa fa-plus-circle")};i.prototype.displayError=function(){this.resetClass(this.element.get(0),"fa fa-exclamation-circle")};i.prototype.displayLoading=function(){this.resetClass(this.element.get(0),"fa fa-spinner fa-pulse fa-fw")};i.prototype.displaySuccess=function(){this.resetClass(this.element.get(0),"fa fa-check-circle")};i.prototype.resetClass=function(n,t){n.className=t};u.prototype.displayMessage=function(n,t){var i={icon:"",bgcolor:"",message:t};"success"===n?(i.icon='<i class="fa fa-check-circle text-success"><\/i>',i.bgcolor="bg-success"):"error"===n&&(i.icon='<i class="fa fa-exclamation-circle text-danger"><\/i>',i.bgcolor="bg-danger");this.displayAlert(i)};u.prototype.displayAlert=function(n){var t=this.element;t.get(0).className=n.bgcolor;t.html(n.icon+"&nbsp;"+n.message);t.show();setTimeout(function(){t.hide()},this.timeout)};r.prototype.dateOffset=0;r.prototype.selectedDate=function(){return new Date(this.startDate).addDays(this.dateOffset)};r.prototype.init=function(){var t=this;n("li:eq(0) a",this.element).click(function(n){n.preventDefault();t.addDays(-1)});n("li:eq(1) a",this.element).click(function(n){n.preventDefault();t.addDays(1)})};r.prototype.addDays=function(n){this.dateOffset+=n;this.displayDate();e.loadItemsForDate(this.selectedDate())};r.prototype.displayDate=function(){var t=this.selectedDate();n("li.info",this.element).text(t.getMonthName()+" "+t.getDate()+", "+t.getFullYear())};t.prototype.init=function(){var t=this;this.placeholderNewItem.click(function(){t.newItem()});n("tbody",this.element).on("click","tr:not(.entry-ph)",function(){t.editItem(this)});n("tbody",this.element).on("click","tr .action-save",function(){t.saveItem(this)});n("tbody",this.element).on("click","tr .action-clear",function(){t.removeItem(this)});n("tbody",this.element).on("keyup paste input","tr td.time div",function(){t.isValidTime(n(this).textOnly())?n(this).parent().removeClass("danger"):n(this).parent().addClass("danger")});e.loadItemsForDate(this.dateNavigationBar.selectedDate())};t.prototype.clearData=function(){n("tbody tr:not(.entry-ph)",this.element).remove();currentTimeLogs=[]};t.prototype.createItems=function(t){var i=this;n(t).each(function(){var n={"{data-id}":this.id,"{from}":this.from,"{to}":this.to?this.to:"","{description}":this.description,"{action}":'<button class="action-clear"><i class="fa fa-times"><\/i><\/button>',"{status}":'<i class="fa fa-check-circle"><\/i>'},t=new o(n);i.placeholderNewItem.before(t.format(i.placeholderLog));currentTimeLogs.push({id:this.id,duration:this.duration})});this.updateTotal();n("tbody tr:not(.entry-ph) td div",this.element).each(function(){n(this).prop("contenteditable","false")})};t.prototype.editItem=function(t){var i=n(t).attr("data-id");i&&i.length>0&&(n("td:lt(3) div",t).each(function(){"false"===n(this).prop("contenteditable")&&n(this).prop("contenteditable","true")}),n(".action-save",t).get(0)||n('<button class="action-save"><i class="fa fa-floppy-o"><\/i><\/button>').insertBefore(n("td:eq(3) .action-clear",t)))};t.prototype.newItem=function(){var n=new o({"{data-id}":"","{from}":"","{to}":"","{description}":"","{action}":'<button class="action-save"><i class="fa fa-floppy-o"><\/i><\/button><button class="action-clear"><i class="fa fa-times"><\/i><\/button>',"{status}":'<i class="fa fa-plus-circle"><\/i>'});this.placeholderNewItem.before(n.format(this.placeholderLog));this.placeholderNewItem.prev().find("td:first-child div").focus()};t.prototype.removeItem=function(t){var f=n(t).parents("tr"),r=f.attr("data-id"),s=new i(f.find("td:last-child i")),e=new u(n("#entry-list-info")),o=this;r&&r.length>0?(s.displayLoading(),n.ajax({url:"/App/api/timelog/"+r,method:"DELETE"}).done(function(){f.remove();currentTimeLogs.removeValue("id",r);o.updateTotal();e.displayMessage("success","Time log removed successfully")}).error(function(i,r,u){if(i.responseText){var f=n.parseJSON(i.responseText);e.displayMessage("error",f.errorDescription?f.errorDescription:f.Message)}else e.displayMessage("error",u);n(t).show()})):(f.remove(),currentTimeLogs.removeValue("id",r),o.updateTotal())};t.prototype.saveItem=function(t){var s=n(t).parents("tr"),f=s.attr("data-id"),r=s.find("td div[contenteditable]"),o=new i(s.find("td:last-child i")),e=new u(n("#entry-list-info")),h=this,c,l;(r.each(function(){n(this).prop("contenteditable",!1)}),c=n(r.get(0)).textOnly(),l=n(r.get(1)).textOnly(),this.isValidTime(c)&&this.isValidTime(l))&&(n(t).hide(),o.displayLoading(),f&&f.length>0?n.ajax({url:"/App/api/timelog/",method:"PUT",data:{id:f,from:c,to:l,description:n(r.get(2)).textOnly(),date:h.dateNavigationBar.selectedDate().toJSON()}}).done(function(i){o.displaySuccess();currentTimeLogs.removeValue("id",f);currentTimeLogs.push({id:f,duration:i.timelog.duration});h.updateTotal();e.displayMessage("success","Time log saved successfully");n(t).remove()}).error(function(i,r,u){if(o.displayError(),i.responseText){var f=n.parseJSON(i.responseText);e.displayMessage("error",f.errorDescription?f.errorDescription:f.Message)}else e.displayMessage("error",u);n(t).show()}):n.post("/App/api/timelog",{id:f,from:c,to:l,description:n(r.get(2)).textOnly(),date:h.dateNavigationBar.selectedDate().toJSON()}).success(function(i){currentTimeLogs.push({id:i.timelog.id,duration:i.timelog.duration});h.updateTotal();o.displaySuccess();s.attr("data-id",i.timelog.id);n(r.get(0)).text(i.timelog.from);i.timelog.to&&n(r.get(1)).text(i.timelog.to);n(t).remove();e.displayMessage("success","Time log saved successfully")}).fail(function(i){o.displayError();i.responseText?e.displayMessage("error",n.parseJSON(i.responseText).errorDescription):e.displayMessage("error",i.statusText);n(t).show()}))};t.prototype.loadItemsForDate=function(){var t=this,i=new u(n("#entry-list-info"));n.get("/App/api/timelog",{date:f.selectedDate().toJSON()}).success(function(n){t.clearData();t.createItems(n.timelogs)}).fail(function(t){t.responseText?i.displayMessage("error",n.parseJSON(t.responseText).errorDescription):i.displayMessage("error",t.statusText);n(obj).show()})};t.prototype.isValidTime=function(n){return null==n||0===n.length||this.regexTimeFormat.test(n)};t.prototype.updateTotal=function(){var n,t,i,r;if(currentTimeLogs){for(n=0,t=0;t<currentTimeLogs.length;t++)n+=currentTimeLogs[t].duration;i=Math.floor(n/60);r=n%60;this.placeholderTotal.text(i+"h "+r+"m")}};n(document).ready(function(){f.init();e.init()})})(jQuery);