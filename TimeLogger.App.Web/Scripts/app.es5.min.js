"use strict";(function(n){function i(n){this.element=n}function o(){}function r(t){this.element=n("#"+t);this.startDate=new Date;this.elementStatus=n("li.status i",this.element)}function t(t){this.regexTimeFormat=/(\d{1,2})[:.](\d{2})\s{0,1}(am|AM|pm|PM)?/;this.element=n("."+t);this.placeholderNewItem=n(".entry-ph",this.element);this.placeholderLog='<tr data-id="{data-id}"><td class="time"><div contenteditable="true">{from}<\/div><\/td><td class="time"><div contenteditable="true">{to}<\/div><\/td><td class="description"><div contenteditable="true">{description}<\/div><\/td><td>{action}<\/td><td>{status}<\/td><\/tr>';this.placeholderTotal=n(".entry-total",this.element);this.dateNavigationBar=u}function f(t){this.element=n("#"+t);this.body=n(".modal-body tbody",this.element)}var u=new r("date-nav"),e=new t("entry-list"),s=new f("dailyReportModal");i.prototype.displayNone=function(){this.resetClass(this.element.get(0),"")};i.prototype.displayNew=function(){this.resetClass(this.element.get(0),"fa fa-plus-circle")};i.prototype.displayError=function(){this.resetClass(this.element.get(0),"fa fa-exclamation-circle")};i.prototype.displayLoading=function(){this.resetClass(this.element.get(0),"fa fa-spinner fa-pulse fa-fw")};i.prototype.displaySuccess=function(){this.resetClass(this.element.get(0),"fa fa-check-circle")};i.prototype.resetClass=function(n,t){n.className=t};o.prototype.format=function(n){var t=Math.floor(n/60),i=n%60;return t+"h "+i+"m"};r.prototype.dateOffset=0;r.prototype.selectedDate=function(){return this.startDate.addDays(this.dateOffset)};r.prototype.init=function(){var t=this;n("li:eq(0) a",this.element).click(function(n){n.preventDefault();t.addDays(-1)});n("li:eq(1) a",this.element).click(function(n){n.preventDefault();t.addDays(1)})};r.prototype.addDays=function(n){this.dateOffset+=n;this.displayDate();this.toggleStatus(!0);var t=this;e.loadItemsForDate(this.selectedDate(),function(){t.toggleStatus(!1)})};r.prototype.displayDate=function(){n("li.info",this.element).text(this.displayDateString(this.selectedDate()))};r.prototype.displayDateString=function(n){return n.getMonthName()+" "+n.getDate()+", "+n.getFullYear()};r.prototype.toggleStatus=function(n){var t=new i(this.elementStatus);n?t.displayLoading():t.displayNone()};t.prototype.init=function(){var t=this;this.placeholderNewItem.click(function(){t.newItem()});n("tbody",this.element).on("click","tr:not(.entry-ph)",function(i){t.editItem(this,n(i.target).get(0))});n("tbody",this.element).on("click","tr .action-save",function(){t.saveItem(this)});n("tbody",this.element).on("click","tr .action-clear",function(){t.removeItem(this)});n("tbody",this.element).on("keyup paste input","tr td.time div",function(){t.isValidTime(n(this).textOnly())?n(this).parent().removeClass("danger"):n(this).parent().addClass("danger")});e.loadItemsForDate(this.dateNavigationBar.selectedDate())};t.prototype.initTypeahead=function(t){n("td.description div",t).typeahead("destroy");n("td.description div",t).typeahead({minLength:1,items:10,showHintOnFocus:!0,source:function(t,i){if(!(1>t.length))return n.get("/App/api/assignmentsearch/",{query:t},function(n){return i(n.assignments)})}})};t.prototype.clearData=function(){n("tbody tr:not(.entry-ph)",this.element).remove();currentTimeLogs=[]};t.prototype.createItems=function(t){var i=this;n(t).each(function(){var n={"{data-id}":this.id,"{from}":this.from,"{to}":this.to?this.to:"","{description}":this.description,"{action}":'<button class="action-clear"><i class="fa fa-times"><\/i><\/button>',"{status}":'<i class="fa fa-check-circle"><\/i>'},t=new TemplateFormatter(n);i.placeholderNewItem.before(t.format(i.placeholderLog));currentTimeLogs.push({id:this.id,duration:this.duration})});this.updateTotal();n("tbody tr:not(.entry-ph) td div",this.element).each(function(){n(this).prop("contenteditable","false")})};t.prototype.editItem=function(t,i){var r=n(t).attr("data-id");r&&r.length>0&&(n("td:lt(3) div",t).each(function(){"false"===n(this).prop("contenteditable")&&(n(this).prop("contenteditable","true"),n("div",i).focus())}),n(".action-save",t).get(0)||n('<button class="action-save"><i class="fa fa-floppy-o"><\/i><\/button>').insertBefore(n("td:eq(3) .action-clear",t)));this.initTypeahead(t)};t.prototype.newItem=function(){var t=new TemplateFormatter({"{data-id}":"","{from}":"","{to}":"","{description}":"","{action}":'<button class="action-save"><i class="fa fa-floppy-o"><\/i><\/button><button class="action-clear"><i class="fa fa-times"><\/i><\/button>',"{status}":'<i class="fa fa-plus-circle"><\/i>'}),n;this.placeholderNewItem.before(t.format(this.placeholderLog));n=this.placeholderNewItem.prev();n.find("td:first-child div").focus();this.initTypeahead(n)};t.prototype.removeItem=function(t){var u=n(t).parents("tr"),r=u.attr("data-id"),o=new i(u.find("td:last-child i")),f=new ErrorHandler(n("#entry-list-info")),e=this;r&&r.length>0?(o.displayLoading(),n.ajax({url:"/App/api/timelog/"+r,method:"DELETE"}).done(function(){u.remove();currentTimeLogs.removeValue("id",r);e.updateTotal();f.displayMessage("success","Time log removed successfully")}).error(function(i,r,u){if(i.responseText){var e=n.parseJSON(i.responseText);f.displayMessage("error",e.errorDescription?e.errorDescription:e.Message)}else f.displayMessage("error",u);n(t).show()})):(u.remove(),currentTimeLogs.removeValue("id",r),e.updateTotal())};t.prototype.saveItem=function(t){var o=n(t).parents("tr"),u=o.attr("data-id"),r=o.find("td div[contenteditable]"),e=new i(o.find("td:last-child i")),f=new ErrorHandler(n("#entry-list-info")),s=this,h,c;(r.each(function(){n(this).prop("contenteditable",!1)}),h=n(r.get(0)).textOnly(),c=n(r.get(1)).textOnly(),this.isValidTime(h)&&this.isValidTime(c))&&(n(t).hide(),e.displayLoading(),u&&u.length>0?n.ajax({url:"/App/api/timelog/",method:"PUT",data:{id:u,from:h,to:c,description:n(r.get(2)).textOnly(),date:s.dateNavigationBar.selectedDate().toApiDateString()}}).done(function(i){e.displaySuccess();currentTimeLogs.removeValue("id",u);currentTimeLogs.push({id:u,duration:i.timelog.duration});s.updateTotal();f.displayMessage("success","Time log saved successfully");n(t).remove()}).error(function(i,r,u){if(e.displayError(),i.responseText){var o=n.parseJSON(i.responseText);f.displayMessage("error",o.errorDescription?o.errorDescription:o.Message)}else f.displayMessage("error",u);n(t).show()}):n.post("/App/api/timelog",{id:u,from:h,to:c,description:n(r.get(2)).textOnly(),date:s.dateNavigationBar.selectedDate().toApiDateString()}).success(function(i){currentTimeLogs.push({id:i.timelog.id,duration:i.timelog.duration});s.updateTotal();e.displaySuccess();o.attr("data-id",i.timelog.id);n(r.get(0)).text(i.timelog.from);i.timelog.to&&n(r.get(1)).text(i.timelog.to);n(t).remove();f.displayMessage("success","Time log saved successfully")}).fail(function(i){e.displayError();i.responseText?f.displayMessage("error",n.parseJSON(i.responseText).errorDescription):f.displayMessage("error",i.statusText);n(t).show()}))};t.prototype.loadItemsForDate=function(t,i){var r=this,f=new ErrorHandler(n("#entry-list-info"));n.get("/App/api/timelog",{date:u.selectedDate().toApiDateString()}).success(function(n){r.clearData();r.createItems(n.timelogs);i&&i()}).fail(function(t){t.responseText?f.displayMessage("error",n.parseJSON(t.responseText).errorDescription):f.displayMessage("error",t.statusText);i&&i()})};t.prototype.isValidTime=function(n){return null==n||0===n.length||this.regexTimeFormat.test(n)};t.prototype.updateTotal=function(){var t,i,n;if(currentTimeLogs){for(t=0,i=new o,n=0;n<currentTimeLogs.length;n++)t+=currentTimeLogs[n].duration;this.placeholderTotal.text(i.format(t))}};f.prototype.init=function(){var t=this;this.element.on("show.bs.modal",function(){var r=n(this),i=u.selectedDate();r.find(".modal-title span").text(u.displayDateString(i));t.loadForDate(i,function(i){var f,e,r,u;for(t.clearItems(),f=0,e=new o,r=0;r<i.length;r++)u=i[r],t.body.append("<tr><td>"+u.title+"<\/td><td>"+u.durationtext+"<\/td><\/tr>"),f+=u.duration;n("td:last",t.footer).text(e.format(f))})})};f.prototype.loadForDate=function(t,i){var r=this,f=new ErrorHandler(n("#entry-list-info"));r.clearItems();r.displayLoading();n.get("/App/api/report",{date:u.selectedDate().toApiDateString()}).success(function(n){r.clearItems();i&&i(n.reportItems)}).fail(function(t){t.responseText?f.displayMessage("error",n.parseJSON(t.responseText).errorDescription):f.displayMessage("error",t.statusText)})};f.prototype.clearItems=function(){n("tr",this.body).remove()};f.prototype.displayLoading=function(){this.body.append('<tr class="table-loading"><td colspan="2"><i class="fa fa-spinner fa-pulse fa-3x fa-fw"><\/i><\/td><\/tr>')};n(document).ready(function(){u.init();e.init();s.init()})})(jQuery);